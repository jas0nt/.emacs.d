#+STARTUP: overview 
#+PROPERTY: header-args :comments yes :results silent

* Const
#+BEGIN_SRC emacs-lisp
  (defconst jst/emacs-config-file "~/.emacs.d/myinit.org")
  (defconst my-leader-key "<SPC>")
  (defconst main-color "#50fa7b")

  (defconst jst/my-font (if (eq system-type 'gnu/linux)
		    "NotoSansM Nerd Font-18"
		  "Source Code Pro-14"))

#+END_SRC
* Func
** Common
#+BEGIN_SRC emacs-lisp
  ;;;###autoload
  (defun jst/new-scratch-buffer ()
    "create a new scratch buffer to work in. (could be *scratch* - *scratchX*)"
    (interactive)
    (let ((n 0)
          bufname)
      (while (progn
               (setq bufname (concat "*scratch"
                                     (if (= n 0) "" (int-to-string n))
                                     "*"))
               (setq n (1+ n))
               (get-buffer bufname)))
      (switch-to-buffer (get-buffer-create bufname))
      (if (= n 1) (lisp-interaction-mode))))

  ;;;###autoload
  (defun jst/find-config-file ()
    "open emacs config file"
    (interactive)
    (find-file jst/emacs-config-file))

  ;;;###autoload
  (defun jst/reload-config-file ()
    "reload emacs config file"
    (interactive)
    (org-babel-load-file (expand-file-name jst/emacs-config-file)))

  ;;;###autoload
  (defun jst/find-file-in-clipboard ()
    "open file in clipboard"
    (interactive)
    (when (file-exists-p (current-kill 0))
      (find-file (current-kill 0))))

  ;;;###autoload
  (defun jst/toggle-ui-transparency ()
    "toggle UI transparency"
    (interactive)
    (let ((alpha (frame-parameter nil 'alpha)))
      (set-frame-parameter
       nil 'alpha
       (if (eql (cond ((numberp alpha) alpha)
                      ((numberp (cdr alpha)) (cdr alpha))
                      ;; Also handle undocumented (<active> <inactive>) form.
                      ((numberp (cadr alpha)) (cadr alpha)))
                100)
           '(85 . 50) '(100 . 100)))))

  ;;;###autoload
  (defun jst/kill-current-buffer ()
    "kill current buffer but keep the last window"
    (interactive)
    (progn
      (kill-current-buffer)
      (when (> (length (window-list)) 1)
        (delete-window))))

  ;;;###autoload
  (defun jst/string-trim-final-newline (string)
    (let ((len (length string)))
      (cond
       ((and (> len 0) (eql (aref string (- len 1)) ?\n))
        (substring string 0 (- len 1)))
       (t string))))

  ;;;###autoload
  (defun jst/shell-command-to-string-trim (command)
    (jst/string-trim-final-newline (shell-command-to-string command)))
#+END_SRC
** MacOS
#+BEGIN_SRC emacs-lisp
  (defun jst/mac-pbcopy ()
    "copy selected region to system clipboard"
    (interactive)
    (shell-command-on-region (point) (mark) "pbcopy"))

  (defun jst/mac-reveal-in-finder ()
    "reveal current directory in finder"
    (interactive)
    (shell-command "open -R ."))

  ;; control Apple Music
  (defconst jst/mac--music-action-play "play")
  (defconst jst/mac--music-action-pause "pause")
  (defconst jst/mac--music-action-next "next track")
  (defconst jst/mac--music-action-prev "previous track")
  (defconst jst/mac--music-action-status "player state as string")
  (defconst jst/mac--music-action-mute "set mute to true")
  (defconst jst/mac--music-action-unmute "set mute to false")
  (defconst jst/mac--music-status-playing "playing")

  (defun jst/mac--music-do (action)
    "controll MacOS Music app"
    (jst/shell-command-to-string-trim (format "osascript -e \"tell application \\\"Music\\\" to %s\"" action)))

  (defun jst/mac-music-status ()
    (interactive)
    (jst/mac--music-do jst/mac--music-action-status))

  (defun jst/mac-music-launch ()
    (interactive)
    (shell-command "open -a Music"))

  (defun jst/mac-music-play-pause ()
    (interactive)
    (if (equal jst/mac--music-status-playing (jst/mac-music-status))
        (jst/mac--music-do jst/mac--music-action-pause)
      (jst/mac--music-do jst/mac--music-action-play)))

  (defun jst/mac-music-play-next ()
    (interactive)
    (jst/mac--music-do jst/mac--music-action-next)
    (jst/mac--music-do jst/mac--music-action-play))
  (defun jst/mac-music-play-prev ()
    (interactive)
    (jst/mac--music-do jst/mac--music-action-prev))
  (defun jst/mac-music-mute ()
    (interactive)
    (jst/mac--music-do jst/mac--music-action-mute))
  (defun jst/mac-music-unmute ()
    (interactive)
    (jst/mac--music-do jst/mac--music-action-unmute))

#+END_SRC
* Basic
#+begin_src emacs-lisp
  (setq gc-cons-threshold most-positive-fixnum)

  (defvar better-gc-cons-threshold 134217728 ; 128mb
    "The default value to use for `gc-cons-threshold'.

  If you experience freezing, decrease this.  If you experience stuttering, increase this.")

  (add-hook 'emacs-startup-hook
        (lambda ()
          (if (boundp 'after-focus-change-function)
          (add-function :after after-focus-change-function
                (lambda ()
                  (unless (frame-focus-state)
                    (garbage-collect))))
        (add-hook 'after-focus-change-function 'garbage-collect))
          (defun gc-minibuffer-setup-hook ()
        (setq gc-cons-threshold (* better-gc-cons-threshold 2)))

          (defun gc-minibuffer-exit-hook ()
        (garbage-collect)
        (setq gc-cons-threshold better-gc-cons-threshold))

          (add-hook 'minibuffer-setup-hook #'gc-minibuffer-setup-hook)
          (add-hook 'minibuffer-exit-hook #'gc-minibuffer-exit-hook)))


  (prefer-coding-system 'utf-8)
  (setq locale-coding-system 'utf-8)

  (set-language-environment 'utf-8)
  (set-default-coding-systems 'utf-8)
  (set-buffer-file-coding-system 'utf-8)
  (set-clipboard-coding-system 'utf-8)
  (set-file-name-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-selection-coding-system 'utf-8)
  (modify-coding-system-alist 'process "*" 'utf-8)

  ;;custom file
  (setq custom-file (expand-file-name "~/.emacs.d/custom.el" user-emacs-directory))

  ;;diable error tone
  (setq ring-bell-function 'ignore)

  ;;no backup file
  (setq make-backup-files nil)
  (setq auto-save-default nil)

  ;;show recent file
  (recentf-mode 1)
  (setq recentf-max-menu-items 15)

  ;;delete selection
  (delete-selection-mode 1)

  ;;paste from clipboard
  (setq x-select-enable-clipboard t)

  ;;replace Yes/No with y/n
  (fset 'yes-or-no-p 'y-or-n-p)

  ;;exec-path
  (add-to-list 'exec-path "/usr/local/bin")

  ;;emacs deamon
  (if (and (fboundp 'server-running-p) 
       (not (server-running-p)))
      (server-start))

  ;;tab-width
  (setq-default indent-tabs-mode nil)
  (setq-default tab-width 4)
  (setq indent-line-function 'insert-tab)
#+end_src

* Config
** initialize package
#+begin_src emacs-lisp
  (require 'package)
  (setq package-archives '(("elpa"   . "https://elpa.gnu.org/packages/")
			   ("melpa" . "https://melpa.org/packages/")))
  (package-initialize)
  ;; install use-package
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))
  (require 'use-package-ensure)
  (setq use-package-always-ensure t)

  (add-to-list 'load-path
	       (expand-file-name (concat user-emacs-directory "elisp")))

  (defvar bootstrap-version)
  (let ((bootstrap-file
	 (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
	(bootstrap-version 5))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
	  (url-retrieve-synchronously
	   "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
	   'silent 'inhibit-cookies)
	(goto-char (point-max))
	(eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
#+end_src
** shell env
#+begin_src emacs-lisp
  (use-package exec-path-from-shell
    :config
    (when (memq window-system '(mac ns x))
      (exec-path-from-shell-initialize)))
#+end_src
** Evil
#+BEGIN_SRC emacs-lisp
  (use-package evil
    :init
    (setq evil-want-integration t) ;; This is optional since it's already set to t by default.
    (setq evil-want-keybinding nil)
    (setq evil-disable-insert-state-bindings t)
    (setq evil-want-C-i-jump nil)
    (setq evil-want-C-u-scroll t)
    :config
    (evil-mode 1)
    (setq evil-insert-state-cursor '(hollow "yellow")
        evil-normal-state-cursor '(box "green")))

  (use-package evil-collection
    :after (evil)
    :init
    (setq evil-collection-company-use-tng nil)
    :config
    (evil-collection-init))

  (use-package evil-snipe
    :after (evil)
    :config
    (evil-snipe-mode +1)
    (evil-snipe-override-mode +1))

  (use-package evil-surround
    :ensure t
    :config
    (global-evil-surround-mode 1))

  (use-package evil-nerd-commenter
    :after (evil))

  (use-package evil-pinyin
    :after (evil)
    :init
    (setq-default evil-pinyin-scheme 'simplified-xiaohe-all)
    (setq-default evil-pinyin-with-search-rule 'always)
    :config
    (evil-select-search-module 'evil-search-module 'evil-search)
    (global-evil-pinyin-mode))

  (use-package evil-exchange
    :after (evil)
    :config
    (evil-exchange-install))

  (use-package evil-smartparens
    :after (evil smartparens)
    :hook (smartparens-enabled-hook . evil-smartparens-mode))

  (use-package god-mode)
#+END_SRC
** meow
#+BEGIN_SRC emacs-lisp
  (defun jst/meow-yank()
    (interactive)
    (if (region-active-p)
    (meow-replace)
      (meow-yank)))

  (use-package meow
    :disabled t
    :init
    (defun meow-setup ()
      (setq meow-cheatsheet-layout meow-cheatsheet-layout-qwerty)
      (meow-motion-overwrite-define-key
       '("j" . meow-next)
       '("k" . meow-prev)
       '("<escape>" . ignore))
      (meow-leader-define-key
       '("<SPC>" . execute-extended-command)
       ;; SPC j/k will run the original command in MOTION state.
       '("j" . "H-j")
       '("k" . "H-k")
       ;; Use SPC (0-9) for digit arguments.
       '("1" . meow-digit-argument)
       '("2" . meow-digit-argument)
       '("3" . meow-digit-argument)
       '("4" . meow-digit-argument)
       '("5" . meow-digit-argument)
       '("6" . meow-digit-argument)
       '("7" . meow-digit-argument)
       '("8" . meow-digit-argument)
       '("9" . meow-digit-argument)
       '("0" . meow-digit-argument)
       '("/" . meow-keypad-describe-key)
       '("?" . meow-cheatsheet))

      (meow-normal-define-key
       '("@" . meow-kmacro-lines)
       '("%" . meow-query-replace)
       '("{" . backward-paragraph)
       '("}" . forward-paragraph)
       '("/" . meow-visit)
       '("0" . meow-expand-0)
       '("9" . meow-expand-9)
       '("8" . meow-expand-8)
       '("7" . meow-expand-7)
       '("6" . meow-expand-6)
       '("5" . meow-expand-5)
       '("4" . meow-expand-4)
       '("3" . meow-expand-3)
       '("2" . meow-expand-2)
       '("1" . meow-expand-1)
       '("-" . negative-argument)
       '(";" . meow-reverse)
       '("," . meow-inner-of-thing)
       '("." . meow-bounds-of-thing)
       '("[" . meow-beginning-of-thing)
       '("]" . meow-end-of-thing)
       '("a" . meow-append)
       '("b" . meow-back-word)
       '("B" . meow-back-symbol)
       '("c" . meow-change)
       '("d" . meow-kill)
       '("e" . meow-mark-word)
       '("E" . meow-mark-symbol)
       '("f" . meow-find)
       '("g" . meow-cancel-selection)
       '("G" . meow-grab)
       '("h" . meow-left)
       '("H" . meow-left-expand)
       '("i" . meow-insert)
       '("j" . meow-next)
       '("J" . meow-next-expand)
       '("k" . meow-prev)
       '("K" . meow-prev-expand)
       '("l" . meow-right)
       '("L" . meow-right-expand)
       '("m" . meow-join)
       '("n" . meow-search)
       '("o" . meow-open-below)
       '("O" . meow-open-above)
       '("p" . jst/meow-yank)
       '("q" . meow-quit)
       '("Q" . meow-goto-line)
       '("r" . meow-replace)
       '("R" . meow-swap-grab)
       '("s" . meow-block)
       '("S" . meow-to-block)
       '("t" . meow-till)
       '("u" . meow-undo)
       '("U" . meow-undo-in-selection)
       '("v" . meow-line)
       '("V" . meow-goto-line)
       '("w" . meow-next-word)
       '("W" . meow-next-symbol)
       '("x" . meow-delete)
       '("X" . meow-backward-delete)
       '("y" . meow-save)
       '("Y" . meow-sync-grab)
       '("z" . meow-pop-selection)
       '("'" . repeat)
       '("+" . er/expand-region)
       '("<escape>" . ignore)))
    :config
    (add-to-list 'meow-mode-state-list '(blink-search-mode . insert))
    (meow-thing-register 'single-quote '(regexp "'" "'") '(regexp "'" "'"))
    (meow-thing-register 'angle '(regexp "<" ">") '(regexp "<" ">"))

    (setq meow-char-thing-table
      '((?( . round) (?) . round)
        (?{ . curly) (?} . curly)
        (?[ . square) (?] . square)
        (?< . angle) (?> . angle)
        (?\" . string)
        (?' . single-quote)
        (?b . buffer)
        (?w . window)
        (?. . sentence)
        (?v . line)
        (?f . defun)
        (?p . paragraph)
        (?s . symbol)))

    (meow-setup)
    (meow-global-mode 1))
#+END_SRC
** edit
#+BEGIN_SRC emacs-lisp
  (use-package markmacro
    :load-path "~/.emacs.d/elisp/markmacro"
    :config
    (global-set-key (kbd "s-/") 'markmacro-mark-words)
    (global-set-key (kbd "s-?") 'markmacro-mark-lines)
    (global-set-key (kbd "s-L") 'markmacro-mark-imenus)
    (global-set-key (kbd "s-<") 'markmacro-apply-all)
    (global-set-key (kbd "s->") 'markmacro-apply-all-except-first)
    (global-set-key (kbd "s-M") 'markmacro-rect-set)
    (global-set-key (kbd "s-D") 'markmacro-rect-delete)
    (global-set-key (kbd "s-F") 'markmacro-rect-replace)
    (global-set-key (kbd "s-I") 'markmacro-rect-insert)
    (global-set-key (kbd "s-C") 'markmacro-rect-mark-columns)
    (global-set-key (kbd "s-S") 'markmacro-rect-mark-symbols))

  (use-package expand-region)

  (use-package aggressive-indent
    :disabled t
    :config
    (global-aggressive-indent-mode 1))

  (use-package ialign)

  (use-package rainbow-delimiters
    :config
    (rainbow-delimiters-mode)
    (add-hook 'prog-mode-hook #'rainbow-delimiters-mode))

  (use-package yasnippet
    :config
    (yas-reload-all)
    (add-hook 'prog-mode-hook #'yas-minor-mode))

  (use-package yasnippet-snippets)

  (use-package undo-tree
    :init
    (global-undo-tree-mode))

  (use-package flycheck
    :disabled t
    :init
    (global-flycheck-mode))

  (use-package hideshow
    :hook (prog-mode . hs-minor-mode))

  (use-package symbol-overlay)
#+END_SRC
** dired
#+BEGIN_SRC emacs-lisp
  (use-package dirvish)

  (when (string= system-type "darwin")
    (require 'dired-x)
    (setq dired-guess-shell-alist-user '(("\\.*\\'" "open")))
    (setq dired-use-ls-dired nil))

  (setq dired-listing-switches "-alht")
#+END_SRC
** completion
#+BEGIN_SRC emacs-lisp
  (use-package markdown-mode
    :mode ("README\\.md\\'" . gfm-mode)
    :init (setq markdown-command "multimarkdown"))

  (use-package corfu-doc
    ;; NOTE 2022-02-05: At the time of writing, `corfu-doc' is not yet on melpa
    :straight (corfu-doc :type git :host github :repo "galeo/corfu-doc")
    :after corfu
    :hook (corfu-mode . corfu-doc-mode)
    :custom
    (corfu-doc-delay 0.5)
    (corfu-doc-max-width 70)
    (corfu-doc-max-height 20)

    ;; NOTE 2022-02-05: I've also set this in the `corfu' use-package to be
    ;; extra-safe that this is set when corfu-doc is loaded. I do not want
    ;; documentation shown in both the echo area and in the `corfu-doc' popup.
    (corfu-echo-documentation nil))


  (unless (display-graphic-p)
    (progn
      (straight-use-package
       '(popon :type git :repo "https://codeberg.org/akib/emacs-popon.git"))
      (straight-use-package
       '(corfu-terminal :type git
			:repo "https://codeberg.org/akib/emacs-corfu-terminal.git"))
      (require 'popon)
      (require 'corfu-terminal)
      (corfu-terminal-mode +1)))


  (use-package orderless
    :init
    (setq completion-styles '(orderless)
	  completion-category-defaults nil
	  completion-category-overrides '((file (styles partial-completion)))))

  ;; Use dabbrev with Corfu!
  (use-package dabbrev
    ;; Swap M-/ and C-M-/
    :bind (("M-/" . dabbrev-completion)
	   ("C-M-/" . dabbrev-expand)))

  ;; A few more useful configurations...
  (use-package emacs
    :init
    ;; TAB cycle if there are only few candidates
    (setq completion-cycle-threshold 3)

    ;; Emacs 28: Hide commands in M-x which do not apply to the current mode.
    ;; Corfu commands are hidden, since they are not supposed to be used via M-x.
    ;; (setq read-extended-command-predicate
    ;;       #'command-completion-default-include-p)

    ;; Enable indentation+completion using the TAB key.
    ;; `completion-at-point' is often bound to M-TAB.
    (setq tab-always-indent 'complete))

  (use-package vertico
    :init
    (vertico-mode))

  (use-package marginalia
    :init
    (marginalia-mode t))

  (use-package embark
    :ensure t
    :bind
    (("C-c ." . embark-act)         ;; pick some comfortable binding
     ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'
    :init
    ;; Optionally replace the key help with a completing-read interface
    (setq prefix-help-command #'embark-prefix-help-command)
    :config
    ;; Hide the mode line of the Embark live/completions buffers
    (add-to-list 'display-buffer-alist
		 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
		   nil
		   (window-parameters (mode-line-format . none)))))

  ;; Consult users will also want the embark-consult package.
  (use-package embark-consult
    :ensure t
    :after (embark consult)
    :demand t ; only necessary if you have the hook below
    ;; if you want to have consult previews as you move around an
    ;; auto-updating embark collect buffer
    :hook
    (embark-collect-mode . consult-preview-at-point-mode))
  (use-package savehist
    :init
    (savehist-mode))

  (use-package consult
    :config
    (consult-customize
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file consult-xref
     :preview-key (kbd "M-.")))
#+END_SRC
** version-control
#+BEGIN_SRC emacs-lisp
  (use-package magit)

  (use-package git-messenger
    :init (setq git-messenger:show-detail t
		git-messenger:use-magit-popup t))

  (use-package git-timemachine)
#+END_SRC
** lsp
#+BEGIN_SRC emacs-lisp
  ;;(use-package lsp-bridge
  ;;  :load-path "~/.emacs.d/elisp/lsp-bridge"
  ;;  :config
  ;;  ;; (require 'lsp-bridge)
  ;;  (yas-global-mode 1)
  ;;  (global-lsp-bridge-mode)
  ;;  )

  (use-package lsp-bridge
    :disabled t
    :straight '(lsp-bridge :type git :host github :repo "manateelazycat/lsp-bridge"
               :files (:defaults "*.el" "*.py" "acm" "core" "langserver" "multiserver" "resources")
               :build (:not compile))
    :init
    (global-lsp-bridge-mode))

  (use-package nix-mode)
#+END_SRC
** terminal
#+BEGIN_SRC emacs-lisp
  (setq-default shell-file-name "/home/jason/.nix-profile/bin/fish")

  (use-package eshell
    :ensure nil
    :defines eshell-prompt-function
    :functions eshell/alias
    :hook (eshell-mode . (lambda ()
			   (bind-key "C-l" 'eshell/clear eshell-mode-map)
			   (setq-local company-mode nil)
			   ;; Aliases
			   (eshell/alias "f" "find-file $1")
			   (eshell/alias "fo" "find-file-other-window $1")
			   (eshell/alias "d" "dired $1")
			   (eshell/alias "l" "ls -lFh")
			   (eshell/alias "ll" "ls -l")
			   (eshell/alias "la" "ls -lAFh")
			   (eshell/alias "lr" "ls -tRFh")
			   (eshell/alias "lrt" "ls -lFcrt")
			   (eshell/alias "lsa" "ls -lah")
			   (eshell/alias "lt" "ls -ltFh")))
    :config
    (with-no-warnings
      ;; For compatibility
      (unless (fboundp 'flatten-tree)
	(defalias 'flatten-tree #'eshell-flatten-list))

      (defun eshell/clear ()
	"Clear the eshell buffer."
	(interactive)
	(let ((inhibit-read-only t))
	  (erase-buffer)
	  (eshell-send-input)))

      (defun eshell/emacs (&rest args)
	"Open a file (ARGS) in Emacs.  Some habits die hard."
	(if (null args)
	    ;; If I just ran "emacs", I probably expect to be launching
	    ;; Emacs, which is rather silly since I'm already in Emacs.
	    ;; So just pretend to do what I ask.
	    (bury-buffer)
	  ;; We have to expand the file names or else naming a directory in an
	  ;; argument causes later arguments to be looked for in that directory,
	  ;; not the starting directory
	  (mapc #'find-file (mapcar #'expand-file-name (flatten-tree (reverse args))))))
      (defalias 'eshell/e #'eshell/emacs)
      (defalias 'eshell/ec #'eshell/emacs)

      (defun eshell/ebc (&rest args)
	"Compile a file (ARGS) in Emacs. Use `compile' to do background make."
	(if (eshell-interactive-output-p)
	    (let ((compilation-process-setup-function
		   (list 'lambda nil
			 (list 'setq 'process-environment
			       (list 'quote (eshell-copy-environment))))))
	      (compile (eshell-flatten-and-stringify args))
	      (pop-to-buffer compilation-last-buffer))
	  (throw 'eshell-replace-command
		 (let ((l (eshell-stringify-list (flatten-tree args))))
		   (eshell-parse-command (car l) (cdr l))))))
      (put 'eshell/ebc 'eshell-no-numeric-conversions t)

      (defun eshell-view-file (file)
	"View FILE.  A version of `view-file' which properly rets the eshell prompt."
	(interactive "fView file: ")
	(unless (file-exists-p file) (error "%s does not exist" file))
	(let ((buffer (find-file-noselect file)))
	  (if (eq (get (buffer-local-value 'major-mode buffer) 'mode-class)
		  'special)
	      (progn
		(switch-to-buffer buffer)
		(message "Not using View mode because the major mode is special"))
	    (let ((undo-window (list (window-buffer) (window-start)
				     (+ (window-point)
					(length (funcall eshell-prompt-function))))))
	      (switch-to-buffer buffer)
	      (view-mode-enter (cons (selected-window) (cons nil undo-window))
			       'kill-buffer)))))

      (defun eshell/less (&rest args)
	"Invoke `view-file' on a file (ARGS).
  \"less +42 foo\" will go to line 42 in the buffer for foo."
	(while args
	  (if (string-match "\\`\\+\\([0-9]+\\)\\'" (car args))
	      (let* ((line (string-to-number (match-string 1 (pop args))))
		     (file (pop args)))
		(eshell-view-file file)
		(forward-line line))
	    (eshell-view-file (pop args)))))
      (defalias 'eshell/more #'eshell/less)))
#+END_SRC
** dashboard
#+BEGIN_SRC emacs-lisp
  (use-package dashboard
    :init
    (dashboard-setup-startup-hook)
    (setq dashboard-center-content t)
    (setq dashboard-startup-banner "~/.emacs.d/banners/dark_knight.png")
    (setq dashboard-image-banner-max-height 400)
    (setq dashboard-items '((recents . 10)
			    (projects . 7)
			    (bookmarks . 7))))
#+END_SRC
** music
#+BEGIN_SRC emacs-lisp
  (use-package bongo
    ;; :if (eq system-type 'gnu/linux)
    :after (hydra)
    :config
    (setq bongo-logo nil)
    (setq bongo-display-track-icons nil)
    (setq bongo-display-track-lengths nil)
    (setq bongo-display-header-icons nil)
    (setq bongo-display-playback-mode-indicator t)
    (setq bongo-header-line-mode nil)
    (setq bongo-mode-line-indicator-mode nil)
    (setq bongo-field-separator (propertize " · " 'face 'shadow))

    (setq bongo-prefer-library-buffers nil)
    (setq bongo-insert-whole-directory-trees t)
    ;;(setq bongo-join-inserted-tracks nil)
    (setq bongo-enabled-backends '(mpv))

    (defun init-goto-bongo ()
      (interactive)
      (let ((bongo-playlist-buffer-name "*Bongo Playlist*"))
    (unless (get-buffer bongo-playlist-buffer-name)
      (bongo)
      (bongo-insert-directory-tree "~/Music/my_music")
      (goto-char (point-min))
      (bongo-random-playback-mode))
    (switch-to-buffer bongo-playlist-buffer-name))))
#+END_SRC
** python
#+BEGIN_SRC emacs-lisp
  (use-package python-mode
    :config
    (setq python-shell-interpreter "python3"))

  (use-package pyvenv
    :config
    (pyvenv-mode 1))

  (use-package flymake-python-pyflakes)
#+END_SRC
** org
#+BEGIN_SRC emacs-lisp
  (use-package org-modern
    :disabled t
    :hook (org-mode . org-modern-mode)
    :config
    (setq org-confirm-babel-evaluate nil
	  org-src-fontify-natively t
	  org-src-tab-acts-natively t)

    (defvar load-language-list '((emacs-lisp . t)
				 (perl . t)
				 (python . t)
				 (ruby . t)
				 (js . t)
				 (css . t)
				 (sass . t)
				 (C . t)
				 (java . t)
				 (plantuml . t)))

    (org-babel-do-load-languages 'org-babel-load-languages
				 load-language-list)
    ;; Add frame borders and window dividers
    (dolist (face '(window-divider
		    window-divider-first-pixel
		    window-divider-last-pixel))
      (face-spec-reset-face face)
      (set-face-foreground face (face-attribute 'default :background)))
    (set-face-background 'fringe (face-attribute 'default :background))

    (setq
     ;; Edit settings
     org-auto-align-tags nil
     org-tags-column 0
     org-catch-invisible-edits 'show-and-error
     org-special-ctrl-a/e t
     org-insert-heading-respect-content t

     ;; Org styling, hide markup etc.
     org-hide-emphasis-markers t
     org-pretty-entities t
     org-ellipsis "…"

     ;; Agenda styling
     org-agenda-tags-column 0
     org-agenda-block-separator ?─
     org-agenda-time-grid
     '((daily today require-timed)
       (800 1000 1200 1400 1600 1800 2000)
       " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")
     org-agenda-current-time-string
     "⭠ now ─────────────────────────────────────────────────")
    )
#+END_SRC
** markdown
#+BEGIN_SRC emacs-lisp
  (use-package markdown-preview-eww)

  (use-package markdown-mode
    :commands (markdown-mode gfm-mode)
    :mode (("README\\.md\\'" . gfm-mode)
	   ("\\.md\\'" . markdown-mode)
	   ("\\.markdown\\'" . markdown-mode))
    :init (setq markdown-command "multimarkdown"))
#+END_SRC
** 中文
#+BEGIN_SRC emacs-lisp
  (use-package ace-pinyin
    :config
    (ace-pinyin-global-mode +1))

  (use-package pyim
    :init
    (pyim-default-scheme 'xiaohe-shuangpin)
    :config
    ;; 让 vertico 通过 orderless 支持拼音搜索候选项功能
    (defun my-orderless-regexp (orig_func component)
      (let ((result (funcall orig_func component)))
	(pyim-cregexp-build result)))
    (advice-add 'orderless-regexp :around #'my-orderless-regexp))

  (use-package bing-dict)
  (use-package fanyi)

  ;; 中文输入法
  (use-package rime
    :config
    (unless (eq system-type 'gnu/linux)
      (setq rime-librime-root "~/.emacs.d/librime/dist"))
    (setq rime-posframe-properties
	  (list :background-color "#282a36"
		:foreground-color "#bd93f9"
		:font jst/my-font
		:internal-border-width 10))

    (setq default-input-method "rime"
	  rime-show-candidate 'minibuffer))
#+END_SRC
** other
#+BEGIN_SRC emacs-lisp
  ;; jump between windows
  (use-package ace-window
    :init
    (progn
      (global-set-key [remap other-window] 'ace-window)
      (setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l))
      (custom-set-faces
       '(aw-leading-char-face
     ((t (:inhrit ace-jump-face-foreground :height 3.0)))))))

  (use-package discover-my-major
    :bind ("C-h C-m" . discover-my-major))

  (use-package google-this)

  (use-package restart-emacs)

  (use-package restclient
    :mode ("\\.http\\'" . restclient-mode))

  (use-package posframe)

  ;; try a package temporarily
  (use-package try)
  (use-package bufler)
  (use-package find-file-in-project)
  (use-package deadgrep)
  (use-package focus)
  (use-package projectile)

  (use-package popper
    :disabled t
    :defines popper-echo-dispatch-actions
    :commands popper-group-by-projectile
    :bind (:map popper-mode-map
        ("C-h z" . popper-toggle-latest)
        ("C-`"   . popper-cycle)
        ("C-M-<tab>" . popper-toggle-type))
    :hook (after-init . popper-mode)
    :init
    (setq popper-reference-buffers
      '("\\*Messages\\*"
        "Output\\*$" "\\*Pp Eval Output\\*$"
        "\\*Compile-Log\\*"
        "\\*Completions\\*"
        "\\*Warnings\\*"
        "\\*Async Shell Command\\*"
        "\\*Apropos\\*"
        "\\*Backtrace\\*"
        "\\*Calendar\\*"
        "\\*Finder\\*"
        "\\*Embark Actions\\*"

        bookmark-bmenu-mode
        comint-mode
        compilation-mode
        help-mode helpful-mode
        tabulated-list-mode
        Buffer-menu-mode

        gnus-article-mode devdocs-mode
        grep-mode occur-mode rg-mode deadgrep-mode ag-mode pt-mode
        ivy-occur-mode ivy-occur-grep-mode
        process-menu-mode list-environment-mode cargo-process-mode
        youdao-dictionary-mode osx-dictionary-mode fanyi-mode

        "^\\*eshell.*\\*.*$" eshell-mode
        "^\\*shell.*\\*.*$"  shell-mode
        "^\\*terminal.*\\*.*$" term-mode
        "^\\*vterm.*\\*.*$"  vterm-mode

        "\\*DAP Templates\\*$" dap-server-log-mode
        "\\*ELP Profiling Restuls\\*" profiler-report-mode
        "\\*Flycheck errors\\*$" " \\*Flycheck checker\\*$"
        "\\*Paradox Report\\*$" "\\*package update results\\*$" "\\*Package-Lint\\*$"
        "\\*[Wo]*Man.*\\*$"
        "\\*ert\\*$" overseer-buffer-mode
        "\\*gud-debug\\*$"
        "\\*lsp-help\\*$" "\\*lsp session\\*$"
        "\\*quickrun\\*$"
        "\\*tldr\\*$"
        "\\*vc-.*\\*$"
        "^\\*elfeed-entry\\*$"
        "^\\*macro expansion\\**"

        "\\*Agenda Commands\\*" "\\*Org Agenda.*\\*"
        "\\*Org Select\\*" "\\*Capture\\*" "^CAPTURE-.*\\.org*"
        "\\*Gofmt Errors\\*$" "\\*Go Test\\*$" godoc-mode
        "\\*docker-containers\\*" "\\*docker-images\\*" "\\*docker-networks\\*" "\\*docker-volumes\\*"
        "\\*prolog\\*" inferior-python-mode inf-ruby-mode swift-repl-mode
        "\\*rustfmt\\*$" rustic-compilation-mode rustic-cargo-clippy-mode
        rustic-cargo-outdated-mode rustic-cargo-test-moed))

    (with-eval-after-load 'projectile
      (setq popper-group-function #'popper-group-by-projectile))

    (when (display-grayscale-p)
      (setq popper-mode-line
        '(:eval
          (format " %s " (all-the-icons-octicon "pin" :height 0.9 :v-adjust 0.0 :face 'mode-line-emphasis)))))

    (setq popper-echo-dispatch-actions t)
    :config
    (popper-echo-mode 1)

    (with-no-warnings
      (defun my-popper-fit-window-height (win)
    "Determine the height of popup window WIN by fitting it to the buffer's content."
    (fit-window-to-buffer
     win
     (floor (frame-height) 3)
     (floor (frame-height) 3)))
      (setq popper-window-height #'my-popper-fit-window-height)

      (defun popper-close-window-hack (&rest _)
    "Close popper window via `C-g'."
    ;; `C-g' can deactivate region
    (when (and (called-interactively-p 'interactive)
           (not (region-active-p))
           popper-open-popup-alist)
      (let ((window (caar popper-open-popup-alist)))
        (when (window-live-p window)
          (delete-window window)))))
      (advice-add #'keyboard-quit :before #'popper-close-window-hack)))

  (use-package powerthesaurus)
#+END_SRC
* UI
#+BEGIN_SRC emacs-lisp
  (when (eq system-type 'darwin)
    (add-to-list 'default-frame-alist '(ns-transparent-titlebar . t))
    (add-to-list 'default-frame-alist '(ns-appearance . dark))
    (add-hook 'after-load-theme-hook
	      (lambda ()
		(let ((bg (frame-parameter nil 'background-mode)))
		  (set-frame-parameter nil 'ns-appearance bg)
		  (setcdr (assq 'ns-appearance default-frame-alist) bg)))))

  ;; theme
  (use-package dracula-theme
    :init
    (load-theme 'dracula t)
    (set-cursor-color main-color))


  ;; display time
  (display-time-mode 1)
  (setq display-time-24hr-format t)
  (setq display-time-day-and-date t)

  ;; display battery
  (display-battery-mode 1)


  ;; modeline
  (defconst jst/modeline-bg (face-attribute 'mode-line :background))
  (defun jst/flash-mode-line ()
    (let ((bell-color "#ff5555"))
      (set-face-background 'mode-line bell-color)
      (run-with-timer 0.1 nil #'set-face-background 'mode-line jst/modeline-bg)))

  (setq visible-bell nil
	ring-bell-function 'jst/flash-mode-line)

  (use-package doom-modeline
    :after (all-the-icons)
    :init (doom-modeline-mode 1)
    :config
    (setq doom-modeline-major-mode-icon nil)
    (setq doom-modeline-height 1)
    (set-face-attribute 'mode-line nil :family "Source Code Pro" :height 150)
    (set-face-attribute 'mode-line-inactive nil :family "Source Code Pro" :height 150))

  (use-package awesome-tray
    :disabled t
    :load-path "~/.emacs.d/elisp/awesome-tray"
    :init
    (setq awesome-tray-active-modules
	  '("evil" "input-method" "location" "buffer-name" "git" "file-path" "mode-name"))
    :config
    (awesome-tray-mode 1)
    (eval-after-load 'awesome-tray
      '(unless (display-graphic-p) (setq mode-line-format nil))))

  ;; icons
  (use-package all-the-icons)

  (use-package beacon
    :config
    (beacon-mode 1)
    (setq beacon-color main-color))

  ;; set transparency
  ;; (set-frame-parameter (selected-frame) 'alpha '(90 90))
  ;; (add-to-list 'default-frame-alist '(alpha 90 90))

  ;;font
  (add-to-list 'default-frame-alist `(font . ,jst/my-font))
  (when (eq system-type 'darwin)
	(set-fontset-font t 'symbol (font-spec :family "Apple Color Emoji") nil 'prepend))

  ;;hide tool bar
  (tool-bar-mode -1)

  ;;hide scroll bar
  (scroll-bar-mode -1)

  (menu-bar-mode -1)

  ;;show line number
  (display-line-numbers-mode t)

  ;;disable welcome page
  (setq inhibit-splash-screen t)

  ;;default open with full screen
  (setq initial-frame-alist (quote ((fullscreen . maximized))))

  ;;set cursor type
  (setq-default cursor-type 'box)
  (set-cursor-color "#00ff00")
  (blink-cursor-mode 0)

  ;;show match ()
  (add-hook 'emacs-lisp-mode-hook 'show-paren-mode)

  ;;highlight current line
  (when (display-graphic-p)
	(global-hl-line-mode))

  (setq visible-bell nil)

  ;;Display lambda as λ
  (global-prettify-symbols-mode 1)
  (setq prettify-symbols-alist '(("lambda" . 955)))
#+END_SRC
* Keybindings
** MacOS
#+BEGIN_SRC emacs-lisp
  ;; set keys for Apple keyboard, for emacs in OS X
  (when (eq system-type 'darwin)
    (setq mac-command-modifier 'super) ; make cmd key do Meta
    (setq mac-option-modifier 'meta) ; make opt key do Super
    (setq mac-control-modifier 'control) ; make Control key do Control
    (setq ns-function-modifier 'hyper)  ; make Fn key do Hyper
    )
#+END_SRC
** general
#+BEGIN_SRC emacs-lisp
  (use-package general)

  (use-package which-key
    :config
    (setq which-key-idle-delay 0.5)
    (which-key-mode))

  (general-define-key
   "<f5>" 'revert-buffer
   "C-s" 'consult-line
   "M-y" 'yank-pop
   "C-x C-b" 'bufler
   "C-x C-d" 'dirvish)

  (general-create-definer my-leader-def
    :states '(normal insert visual emacs)
    :keymaps 'override
    :prefix my-leader-key
    :non-normal-prefix "C-,")

  (general-define-key
   :states '(normal visual)
   "gl" 'evil-avy-goto-line
   ";" 'switch-to-buffer
   "," 'evil-switch-to-windows-last-buffer
   "." 'evil-avy-goto-char-timer
   "g." 'evil-repeat)
#+END_SRC
** transient
*** buffer
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-buffer ()
    [
     ["actions"
      ("+" "expand-region" er/expand-region)
      ("b" "bufler" bufler)
      ("y" "pbcopy" jst/mac-pbcopy)
      ("s" "switch buffer other window" ido-switch-buffer-other-window)
      ("S" "new scratch" jst/new-scratch-buffer)
      ]
     ])
#+END_SRC
*** comment
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-comment ()
    [
     ["actions"
      ("c" "toggle comment" evilnc-comment-or-uncomment-lines)
      ("p" "comment & copy" evilnc-copy-and-comment-lines)
      ("b" "comment block" evilnc-comment-or-uncomment-paragraphs)
      ]
     ])
#+END_SRC
*** file
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-file ()
    "transient-file"
    [
     ["find-file"
      ("f" "find-file" find-file)
      ("F" "find-file-other-window" find-file-other-window)
      ("r" "recentf" consult-recent-file)
      ("d" "dired" dired)
      ("b" "bookmark" bookmark-jump)
      ("o" "find-file-at-point" find-file-at-point)
      ("p" "find-file-in-kill-ring" jst/find-file-in-clipboard)
      ]
     ["actions"
      ("R" "reveal in finder" jst/mac-reveal-in-finder)
      ("s" "save-buffer" save-buffer)
      ("S" "save-some-buffers" save-some-buffers)
      ]
     ["config-file"
      ("e" "open config" jst/find-config-file)
      ("E" "reload config" jst/reload-config-file)
      ]
     ]
    )
#+END_SRC
*** vc
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-vc ()
    [
     ["actions"
      ("v" "status" magit-status)
      ("m" "show msg" git-messenger:popup-message)
      ]
     ])
#+END_SRC
*** jump
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-jump ()
    [
     ["goto-char"
      ("j" "goto-char-timer" avy-goto-char-timer)
      ("1" "goto-char" avy-goto-char)
      ("2" "goto-char-2" avy-goto-char-2)
      ]

     ["goto-word"
      ("w" "goto-word" avy-goto-word-1)
      ]
   
     ["goto-line"
      ("l" "goto-line" avy-goto-line)
      ]
     ])
#+END_SRC
*** music
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-music ()
    [
     ["♫"
      ("m" "music-player" init-goto-bongo)
      ("<SPC>" "play/pause" bongo-pause/resume)
      ]

     ["play"
      ("r" "random" bongo-play-random)
      ("n" "next" bongo-play-next)
      ("p" "prev" bongo-play-previous)
      ]
   
     ["ctrl"
      ("f" ">> 10" bongo-seek-forward-10)
      ("F" ">> 60" bongo-seek-forward-60)
      ("b" "<< 10" bongo-seek-backward-10)
      ("B" "<< 60" bongo-seek-backward-60)
      ]
   
     ["Apple Music"
      ("M" "music app" jst/mac-music-launch)
      ("j" "next" jst/mac-music-play-next)
      ("k" "prev" jst/mac-music-play-prev)
      ("l" "play/pause" jst/mac-music-play-pause)
      ]
     ])
#+END_SRC
*** quit
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-quit ()
    [
     ["❗"
      ("!" "exit emacs" save-buffers-kill-terminal)
      ("1" "restart-emacs" restart-emacs)
      ]
     ])
#+END_SRC
*** search
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-search ()
    [
     ["content"
      ("i" "imenu" consult-imenu)
      ("r" "rg" consult-ripgrep)
      ("R" "rg+" deadgrep)
      ("m" "multi-buffer" consult-line-multi)
      ]

     ["file"
      ("b" "bookmark" consult-bookmark)
      ("f" "project" find-file-in-project)
      ("L" "locate" consult-locate)
      ]

     ["lookup"
      ("g" "google" google-this)
      ("d" "dict" bing-dict-brief)
      ("D" "fanyi" fanyi-dwim2)
      ("l" "browse-url" browse-url)
      ]
     ])
#+END_SRC
*** terminal
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-terminal ()
    [
     ["actions"
      ("t" ">_" ansi-term)
      ]
     ])
#+END_SRC
*** toggle
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-toggle ()
    [
     ["toggle"
      ("f" "focus-mode" focus-mode)
      ("t" "transparency" jst/toggle-ui-transparency)
      ]
     ])
#+END_SRC
*** window
#+BEGIN_SRC emacs-lisp
  (transient-define-prefix my-transient-window ()
    [
     ["nav"
      ("h" "←" windmove-left :transient t)
      ("j" "↓" windmove-down :transient t)
      ("k" "↑" windmove-up :transient t)
      ("l" "→" windmove-right :transient t)
      ("g" "➶" ace-window :transient t)
      ]

     ["swap"
      ("H" "⮌" windmove-swap-states-left :transient t)
      ("J" "⮏" windmove-swap-states-down :transient t)
      ("K" "⮍" windmove-swap-states-up :transient t)
      ("L" "⮎" windmove-swap-states-right :transient t)
      ("s" "🗘" ace-swap-window :transient t)
      ]

     ["split"
      ("/" "⦶ vertical" (lambda ()
			  (interactive)
			  (split-window-right)
			  (windmove-right)))
      ("?" "⦵ horizontal" (lambda ()
			    (interactive)
			    (split-window-below)
			    (windmove-down)))
      ]

     ["resize"
      ("0" "⊞ balance" balance-windows :transient t)
      ("=" "🡙" enlarge-window :transient t)
      ("-" "🡫" shrink-window :transient t)
      ("." "🡘" enlarge-window-horizontally :transient t)
      ("," "🡨" shrink-window-horizontally :transient t)
      ]

     ["actions"
      ("d" "X 𐤕" delete-window :transient t)
      ("D" "X other" ace-delete-window)
      ("m" "✡ maximum" delete-other-windows)
      (";" "switch" switch-to-buffer)
      ]
     ])
#+END_SRC
*** leader
#+BEGIN_SRC emacs-lisp
  (my-leader-def
    "<SPC>" 'execute-extended-command
    "q" '(jst/kill-current-buffer :wk "kill-buffer")
    "b" 'my-transient-buffer
    "c" 'my-transient-comment
    "f" 'my-transient-file
    "v" 'my-transient-vc
    "j" 'my-transient-jump
    "m" 'my-transient-music
    "<ESC>" 'my-transient-quit
    "s" 'my-transient-search
    "t" 'my-transient-terminal
    "T" 'my-transient-toggle
    "w" 'my-transient-window)

  ;;(meow-leader-define-key
  ;; ;; x, c, h, m, g are occupied
  ;; '("q" . (lambda ()
  ;;	   (interactive)
  ;;	   (progn
  ;;	     (kill-current-buffer)
  ;;	     (when (> (length (window-list)) 1)
  ;;	   (delete-window)))))
  ;; '("," . meow-last-buffer)
  ;; '(";" . switch-to-buffer)
  ;; '("b" . my-transient-buffer)
  ;; '("f" . my-transient-file)
  ;; '("j" . my-transient-jump)
  ;; '("v" . my-transient-vc)
  ;; '("p" . my-transient-music)
  ;; '("s" . my-transient-search))
#+END_SRC
** modes
#+BEGIN_SRC emacs-lisp
  (general-define-key
   :states 'normal
   :keymaps 'bongo-playlist-mode-map
   "RET" 'bongo-play
   "TAB" 'bongo-toggle-collapsed
   "r" 'bongo-play-random
   "p" 'bongo-pause/resume
   "f" 'bongo-seek-forward-10
   "F" 'bongo-seek-forward-60
   "b" 'bongo-seek-backward-10
   "B" 'bongo-seek-backward-60
   "q" 'bongo-stop)
#+END_SRC
